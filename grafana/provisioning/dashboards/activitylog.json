{
  "uid": "activitylog-debug",
  "title": "OpenCloud Activitylog Debug",
  "description": "Monitor activitylog service, NATS, and event processing for upstream issue tracking",
  "tags": ["opencloud", "activitylog", "nats", "debug"],
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 3,
  "refresh": "30s",
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "annotations": {
    "list": []
  },
  "templating": {
    "list": []
  },
  "panels": [
    {
      "id": 100,
      "title": "NATS / JetStream (Loki)",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
      "collapsed": false
    },
    {
      "id": 110,
      "title": "NATS Errors (24h)",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 1 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(count_over_time({container=\"opencloud-opencloud-1\"} |= `\"service\":\"nats\"` | json | level=`error` [24h]))",
          "refId": "A"
        }
      ],
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "textMode": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        }
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "red", "value": 1 }
            ]
          },
          "unit": "short"
        }
      }
    },
    {
      "id": 120,
      "title": "NATS Warnings (24h)",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 1 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(count_over_time({container=\"opencloud-opencloud-1\"} |= `\"service\":\"nats\"` | json | level=`warn` [24h]))",
          "refId": "A"
        }
      ],
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "textMode": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        }
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "orange", "value": 10 }
            ]
          },
          "unit": "short"
        }
      }
    },
    {
      "id": 130,
      "title": "NATS Config Warnings (24h)",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 1 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(count_over_time({container=\"opencloud-opencloud-1\"} |= `nats configuration` [24h]))",
          "refId": "A"
        }
      ],
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "textMode": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        }
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 }
            ]
          },
          "unit": "short"
        }
      }
    },
    {
      "id": 140,
      "title": "Filestore Warnings (24h)",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 1 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(count_over_time({container=\"opencloud-opencloud-1\"} |= `\"service\":\"nats\"` |= `Filestore` [24h]))",
          "refId": "A"
        }
      ],
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "textMode": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        }
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 }
            ]
          },
          "unit": "short"
        }
      }
    },
    {
      "id": 150,
      "title": "NATS Service Logs",
      "type": "logs",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 5 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "{container=\"opencloud-opencloud-1\"} |= `\"service\":\"nats\"` | json | level=~`error|warn`",
          "refId": "A"
        }
      ],
      "options": {
        "showTime": true,
        "showLabels": false,
        "showCommonLabels": false,
        "wrapLogMessage": true,
        "prettifyLogMessage": true,
        "enableLogDetails": true,
        "sortOrder": "Descending"
      }
    },
    {
      "id": 200,
      "title": "Activitylog Errors (Loki)",
      "type": "row",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 13 },
      "collapsed": false
    },
    {
      "id": 210,
      "title": "Activitylog Errors (Last 24h)",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 14 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(count_over_time({container=\"opencloud-opencloud-1\"} |= `\"service\":\"activitylog\"` |= `error` [24h]))",
          "refId": "A"
        }
      ],
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "textMode": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        }
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "red", "value": 10 }
            ]
          },
          "unit": "short"
        }
      }
    },
    {
      "id": 220,
      "title": "Event Processing Errors",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 14 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(count_over_time({container=\"opencloud-opencloud-1\"} |= `\"service\":\"activitylog\"` |= `could not process event` [24h]))",
          "refId": "A"
        }
      ],
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "textMode": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        }
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "red", "value": 1 }
            ]
          },
          "unit": "short"
        }
      }
    },
    {
      "id": 230,
      "title": "Store Errors",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 14 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(count_over_time({container=\"opencloud-opencloud-1\"} |= `\"service\":\"activitylog\"` |~ `error.*(store|activities)` [24h]))",
          "refId": "A"
        }
      ],
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "textMode": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        }
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "red", "value": 1 }
            ]
          },
          "unit": "short"
        }
      }
    },
    {
      "id": 240,
      "title": "Unknown Events",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 14 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum(count_over_time({container=\"opencloud-opencloud-1\"} |= `\"service\":\"activitylog\"` |= `event not registered` [24h]))",
          "refId": "A"
        }
      ],
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "textMode": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        }
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 }
            ]
          },
          "unit": "short"
        }
      }
    },
    {
      "id": 250,
      "title": "Error Rate Over Time",
      "type": "timeseries",
      "gridPos": { "h": 6, "w": 24, "x": 0, "y": 18 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "sum by (level) (count_over_time({container=\"opencloud-opencloud-1\"} |= `\"service\":\"activitylog\"` | json | level=~`error|warn` [$__interval]))",
          "legendFormat": "{{level}}",
          "refId": "A"
        }
      ],
      "options": {
        "legend": { "showLegend": true, "displayMode": "list", "placement": "bottom" }
      },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "bars",
            "fillOpacity": 50,
            "stacking": { "mode": "normal" }
          },
          "color": { "mode": "palette-classic" }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "error" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "warn" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] }
        ]
      }
    },
    {
      "id": 260,
      "title": "All Activitylog Errors",
      "type": "logs",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 24 },
      "datasource": { "type": "loki", "uid": "loki" },
      "targets": [
        {
          "expr": "{container=\"opencloud-opencloud-1\"} |= `\"service\":\"activitylog\"` | json | level=~`error|warn`",
          "refId": "A"
        }
      ],
      "options": {
        "showTime": true,
        "showLabels": false,
        "showCommonLabels": false,
        "wrapLogMessage": true,
        "prettifyLogMessage": true,
        "enableLogDetails": true,
        "sortOrder": "Descending"
      }
    }
  ]
}
