{
  "uid": "opencloud-overview",
  "title": "OpenCloud Overview",
  "description": "Quick health check for OpenCloud. Shows key metrics at a glance: request rate, error rate, latency, and active transfers.",
  "tags": ["opencloud", "overview"],
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 3,
  "refresh": "30s",
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "panels": [
    {
      "id": 10,
      "title": "Requests/s",
      "description": "HTTP requests per second at the OpenCloud proxy. Measures current system load. Normal: 1-50 req/s for small teams. Yellow >100, Red >500 indicates high load or possible attack.",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 100 },
              { "color": "red", "value": 500 }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "value",
        "graphMode": "area"
      },
      "targets": [
        {
          "expr": "sum(rate(opencloud_proxy_requests_total[5m]))",
          "legendFormat": "Requests/s"
        }
      ]
    },
    {
      "id": 20,
      "title": "Error Rate",
      "description": "Percentage of failed requests (5xx errors, timeouts). Green <1% is normal. Yellow 1-5% indicates issues. Red >5% requires immediate investigation - check logs in Loki dashboard.",
      "type": "gauge",
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "min": 0,
          "max": 10,
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "red", "value": 5 }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "showThresholdLabels": false,
        "showThresholdMarkers": true
      },
      "targets": [
        {
          "expr": "sum(rate(opencloud_proxy_errors_total[5m])) / sum(rate(opencloud_proxy_requests_total[5m])) * 100",
          "legendFormat": "Error %"
        }
      ]
    },
    {
      "id": 30,
      "title": "P95 Latency",
      "description": "95% of all requests complete faster than this value. Reflects user experience for most users. Green <500ms is good. Yellow 0.5-2s is acceptable. Red >2s means noticeable delays for users.",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 0.5 },
              { "color": "red", "value": 2 }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "value",
        "graphMode": "area"
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(opencloud_proxy_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "P95"
        }
      ]
    },
    {
      "id": 40,
      "title": "Goroutines",
      "description": "Number of active goroutines in the OpenCloud process. Normal: 500-1500. Steadily increasing value without decline may indicate a goroutine leak. Yellow >2000, Red >5000 requires investigation.",
      "type": "stat",
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 2000 },
              { "color": "red", "value": 5000 }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "value",
        "graphMode": "area"
      },
      "targets": [
        {
          "expr": "sum(go_goroutines{job=\"opencloud\"})",
          "legendFormat": "Goroutines"
        }
      ]
    },
    {
      "id": 50,
      "title": "Request Rate & Errors",
      "description": "Correlation between load and errors over time. Green line = requests (left axis), red line = errors (right axis). Do errors rise proportionally with requests? System is overloaded. Errors without request spike indicate other problems.",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 4 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 10,
            "pointSize": 5,
            "showPoints": "never"
          }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Errors/s" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } },
              { "id": "custom.axisPlacement", "value": "right" },
              { "id": "custom.fillOpacity", "value": 0 },
              { "id": "custom.lineWidth", "value": 2 }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Requests/s" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }
            ]
          }
        ]
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "expr": "sum(rate(opencloud_proxy_requests_total[5m]))",
          "legendFormat": "Requests/s"
        },
        {
          "expr": "sum(rate(opencloud_proxy_errors_total[5m]))",
          "legendFormat": "Errors/s"
        }
      ]
    },
    {
      "id": 60,
      "title": "Latency Percentiles",
      "description": "Response times by percentile: P50 (median, green) = typical user. P95 (yellow) = slow requests. P99 (red) = worst case. Large gap between P50 and P99 indicates outliers - check Request Details dashboard.",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 12 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 0,
            "pointSize": 5,
            "showPoints": "never"
          }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "P50" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "P95" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "P99" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }
            ]
          }
        ]
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.50, sum(rate(opencloud_proxy_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "P50"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(opencloud_proxy_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "P95"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(opencloud_proxy_duration_seconds_bucket[5m])) by (le))",
          "legendFormat": "P99"
        }
      ]
    },
    {
      "id": 70,
      "title": "Active Transfers",
      "description": "Active file transfers: Uploads (blue), Downloads (purple), Processing (orange). Processing = files being processed after upload (antivirus, indexing). High processing values may indicate slow ClamAV.",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 12 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": {
            "drawStyle": "line",
            "lineWidth": 2,
            "fillOpacity": 20,
            "pointSize": 5,
            "showPoints": "never"
          }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Uploads" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "blue", "mode": "fixed" } }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Downloads" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "purple", "mode": "fixed" } }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Processing" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }
            ]
          }
        ]
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "expr": "sum(reva_upload_active)",
          "legendFormat": "Uploads"
        },
        {
          "expr": "sum(reva_download_active)",
          "legendFormat": "Downloads"
        },
        {
          "expr": "sum(reva_upload_processing)",
          "legendFormat": "Processing"
        }
      ]
    },
    {
      "id": 80,
      "title": "Upload Pipeline",
      "description": "Upload lifecycle per minute: Initiated → Transfer Complete → Scanned (antivirus) → Finalized or Aborted. Gap between stages shows drop-off. Many Aborted = problem with uploads or antivirus.",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 16, "x": 0, "y": 20 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "custom": {
            "drawStyle": "line",
            "lineWidth": 1,
            "fillOpacity": 30,
            "pointSize": 5,
            "showPoints": "never",
            "stacking": { "mode": "normal" }
          }
        },
        "overrides": [
          {
            "matcher": { "id": "byName", "options": "Initiated" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "blue", "mode": "fixed" } }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Scanned" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Finalized" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }
            ]
          },
          {
            "matcher": { "id": "byName", "options": "Aborted" },
            "properties": [
              { "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }
            ]
          }
        ]
      },
      "options": {
        "tooltip": { "mode": "multi", "sort": "desc" },
        "legend": { "displayMode": "list", "placement": "bottom" }
      },
      "targets": [
        {
          "expr": "sum(rate(reva_upload_sessions_initiated[5m])) * 60",
          "legendFormat": "Initiated"
        },
        {
          "expr": "sum(rate(reva_upload_sessions_scanned[5m])) * 60",
          "legendFormat": "Scanned"
        },
        {
          "expr": "sum(rate(reva_upload_sessions_finalized[5m])) * 60",
          "legendFormat": "Finalized"
        },
        {
          "expr": "sum(rate(reva_upload_sessions_aborted[5m])) * 60",
          "legendFormat": "Aborted"
        }
      ]
    },
    {
      "id": 90,
      "title": "Event Queues",
      "description": "Async processing queues. Postprocessing = upload post-processing (antivirus, thumbnails). Search = search index updates. Values >0 are normal during activity but should not keep increasing. Yellow >10, Red >100 = backlog building up.",
      "type": "stat",
      "gridPos": { "h": 4, "w": 8, "x": 16, "y": 20 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 10 },
              { "color": "red", "value": 100 }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "value",
        "graphMode": "area",
        "textMode": "auto"
      },
      "targets": [
        {
          "expr": "sum(opencloud_postprocessing_events_unprocessed)",
          "legendFormat": "Postprocessing"
        },
        {
          "expr": "sum(opencloud_search_events_unprocessed)",
          "legendFormat": "Search"
        }
      ]
    },
    {
      "id": 100,
      "title": "Memory Usage",
      "description": "Heap memory usage of OpenCloud process. Normal: 50-200 MB. Yellow >512 MB, Red >1 GB. Steadily increasing value without decline after GC indicates memory leak. If issues persist: restart container.",
      "type": "stat",
      "gridPos": { "h": 4, "w": 8, "x": 16, "y": 24 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "unit": "bytes",
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 536870912 },
              { "color": "red", "value": 1073741824 }
            ]
          }
        }
      },
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "value",
        "graphMode": "area"
      },
      "targets": [
        {
          "expr": "sum(go_memstats_heap_alloc_bytes{job=\"opencloud\"})",
          "legendFormat": "Heap"
        }
      ]
    }
  ]
}
