# OpenCloud PLG Dashboards

Grafana dashboards for monitoring OpenCloud with the PLG stack (Prometheus + Loki + Grafana).

## Dashboards

### OpenCloud Dashboards

| Dashboard | UID | Datasource | Description | Docs |
|-----------|-----|------------|-------------|------|
| **Overview** | `opencloud-overview` | Prometheus | Quick health check (start here) | [ğŸ“–](grafana/provisioning/dashboards/opencloud-overview.md) |
| **Logs** | `opencloud-logs` | Loki | Service/Component/Level filter | [ğŸ“–](grafana/provisioning/dashboards/opencloud-logs.md) |
| **Proxy** | `opencloud-proxy` | Loki | HTTP access logs, traffic analysis | [ğŸ“–](grafana/provisioning/dashboards/opencloud-proxy.md) |
| **Uploads** | `opencloud-uploads` | Prometheus | File uploads, antivirus, processing | [ğŸ“–](grafana/provisioning/dashboards/opencloud-uploads.md) |
| **Requests** | `opencloud-requests` | Prometheus | Performance analysis, latency | [ğŸ“–](grafana/provisioning/dashboards/opencloud-requests.md) |
| Activitylog Debug | `activitylog-debug` | Loki | Event debugging (for upstream issues) | [ğŸ“–](grafana/provisioning/dashboards/activitylog.md) |

### External Dashboards

Downloaded from Grafana.com during deployment:

| Dashboard | UID | Source | Description | Docs |
|-----------|-----|--------|-------------|------|
| Node Exporter Full | `node-exporter-full` | [#1860](https://grafana.com/grafana/dashboards/1860) | Linux server metrics | [ğŸ“–](grafana/provisioning/dashboards/node-exporter.md) |
| Prometheus Stats | `prometheus-stats` | [#3662](https://grafana.com/grafana/dashboards/3662) | Prometheus self-monitoring | [ğŸ“–](grafana/provisioning/dashboards/prometheus-stats.md) |

## Dashboard Navigation

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  OpenCloud Overview â”‚ â† Start here
                    â”‚     (Prometheus)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                   â”‚                   â”‚
           â–¼                   â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Requests   â”‚     â”‚   Uploads   â”‚     â”‚    Logs     â”‚
    â”‚ (Prometheus)â”‚     â”‚ (Prometheus)â”‚     â”‚   (Loki)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚                   â”‚                   â”‚
                               â–¼                   â–¼                   â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    Proxy    â”‚     â”‚ Activitylog â”‚     â”‚  (filter by â”‚
                        â”‚   (Loki)    â”‚     â”‚   (Loki)    â”‚     â”‚  component) â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Structure

```
src/                                    # Dashboard source (TypeScript)
â”œâ”€â”€ shared.ts                           # Datasources, query helpers, thresholds
â”œâ”€â”€ activitylog.ts                      # Activitylog Debug dashboard
â”œâ”€â”€ opencloud-overview.ts               # Overview dashboard
â”œâ”€â”€ opencloud-logs.ts                   # Logs dashboard
â”œâ”€â”€ opencloud-proxy.ts                  # Proxy dashboard
â”œâ”€â”€ opencloud-uploads.ts                # Uploads dashboard
â””â”€â”€ opencloud-requests.ts               # Requests dashboard
grafana/
â””â”€â”€ provisioning/
    â”œâ”€â”€ dashboards/
    â”‚   â”œâ”€â”€ dashboards.yml              # Provisioning config
    â”‚   â”œâ”€â”€ *.json                      # Generated by `bun run build` (gitignored)
    â”‚   â”œâ”€â”€ opencloud-overview.md       # Dashboard documentation
    â”‚   â”œâ”€â”€ opencloud-logs.md           # Dashboard documentation
    â”‚   â”œâ”€â”€ opencloud-proxy.md          # Dashboard documentation
    â”‚   â”œâ”€â”€ opencloud-uploads.md        # Dashboard documentation
    â”‚   â”œâ”€â”€ opencloud-requests.md       # Dashboard documentation
    â”‚   â”œâ”€â”€ activitylog.md              # Dashboard documentation
    â”‚   â”œâ”€â”€ node-exporter.md            # Docs for external dashboard
    â”‚   â””â”€â”€ prometheus-stats.md         # Docs for external dashboard
    â””â”€â”€ datasources/
        â””â”€â”€ datasources.yml             # Prometheus + Loki
```

### Panel ID Convention

Panel IDs follow a row-based numbering scheme:

| Element | IDs | Example |
|---------|-----|---------|
| Row panels | 100, 200, 300... | Row 200 = second section |
| Panels in row | +10, +20, +30... | Panel 230 = 3rd panel in Row 200 |
| No rows (Overview) | 10, 20, 30... | Flat structure |

Benefits: Clear hierarchy, room for growth (insert 115 between 110/120), easy debugging.

## Development

Dashboards are written in TypeScript using the [Grafana Foundation SDK](https://github.com/grafana/grafana-foundation-sdk). Each `src/*.ts` file defines a dashboard with typed builders and generates JSON via `console.log(JSON.stringify(dashboard.build()))`. The generated JSON is **not committed** â€” it is built during deployment and in CI.

### Grafana Foundation SDK

| Resource | Link |
|----------|------|
| Documentation | [grafana.com/docs/.../foundation-sdk](https://grafana.com/docs/grafana/latest/observability-as-code/foundation-sdk/) |
| API Reference | [grafana.github.io/grafana-foundation-sdk](https://grafana.github.io/grafana-foundation-sdk/) |
| GitHub | [grafana/grafana-foundation-sdk](https://github.com/grafana/grafana-foundation-sdk) |
| npm | [@grafana/grafana-foundation-sdk](https://www.npmjs.com/package/@grafana/grafana-foundation-sdk) |
| SDK Version | `~11.6.0-cogv0.0.x` (matches Grafana 11.6) |

**Key patterns used:**

| Builder | Import | Used for |
|---------|--------|----------|
| `DashboardBuilder` | `dashboard` | Dashboard metadata, variables, rows |
| `PanelBuilder as StatBuilder` | `stat` | Single-value stat panels |
| `PanelBuilder as TimeseriesBuilder` | `timeseries` | Time series charts |
| `PanelBuilder as GaugeBuilder` | `gauge` | Gauge panels |
| `PanelBuilder as LogsBuilder` | `logs` | Log stream panels |
| `PanelBuilder as PiechartBuilder` | `piechart` | Pie charts |
| `PanelBuilder as TableBuilder` | `table` | Table panels |
| `PanelBuilder as BarGaugeBuilder` | `bargauge` | Bar gauge panels |
| `PanelBuilder as HeatmapBuilder` | `heatmap` | Heatmap panels |
| `DataqueryBuilder` | `prometheus`, `loki` | Query definitions |

`src/shared.ts` provides reusable helpers: datasource refs, query factories (`promQuery`, `lokiQuery`), threshold factories (`greenYellowRed`, etc.), and override helpers (`colorOverride`, `regexpColorOverride`).

### Prerequisites (local development only)

- [Bun](https://bun.sh/) runtime (optional â€” CI and deployment install Bun automatically)

### Build

```bash
bun install
bun run build        # Build all dashboards
bun run typecheck    # Type check only
```

Individual dashboards:

```bash
bun run build:opencloud-overview
bun run build:opencloud-logs
# etc.
```

### Workflow

1. Edit TypeScript source in `src/`
2. Commit and push (only TypeScript, JSON is gitignored)
3. CI validates (typecheck + build)
4. Deployment builds JSON on the server with Bun

### CI

The [`validate-dashboards.yml`](.github/workflows/validate-dashboards.yml) workflow runs on push/PR to `main` when `src/`, `package.json`, or `tsconfig.json` change:

1. **Type check** â€” `bun run typecheck` (catches type errors, wrong builder methods)
2. **Build** â€” `bun run build` (verifies all 6 dashboards generate valid JSON)

### Deployment

A deployment workflow clones this repo, runs `bun install --frozen-lockfile && bun run build`, and copies the generated JSON to Grafana's provisioning directory.

## Usage

These dashboards are designed for use with:
- **OpenCloud** metrics (Prometheus)
- **OpenCloud** logs (Loki via Grafana Alloy)

### Requirements

- Grafana 10.x or 11.x
- Prometheus datasource (UID: `prometheus`)
- Loki datasource (UID: `loki`)

### Installation

```bash
bun install && bun run build
```

Then copy `grafana/provisioning/` to your Grafana provisioning directory. Or import individual JSON files via Grafana UI â†’ Dashboards â†’ Import.

### External Dashboards

External dashboards (Node Exporter, Prometheus Stats) are downloaded from Grafana.com during deployment and processed to set stable UIDs, replace datasource variables, and adapt label names for Alloy.

## Related

- [OpenCloud](https://github.com/opencloud-eu/opencloud) - The cloud platform
- [OpenCloud Compose](https://github.com/opencloud-eu/opencloud-compose) - Docker Compose deployment

## License

MIT
